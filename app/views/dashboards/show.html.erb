<div style="padding: 20px; font-family: sans-serif;">
  <h1>ÈÖçÁ•û</h1>

  <div style="margin-bottom: 20px;">
    <%= link_to "‚Üê Ââç„ÅÆÈÄ±", dashboard_path(date: @base_date - 7.days), style: "text-decoration: none; padding: 5px 10px; border: 1px solid #ccc;" %>
    <strong style="margin: 0 15px;"><%= @start_date.strftime("%YÂπ¥%mÊúà%dÊó•") %> „Äú <%= @end_date.strftime("%mÊúà%dÊó•") %></strong>
    <%= link_to "Ê¨°„ÅÆÈÄ± ‚Üí", dashboard_path(date: @base_date + 7.days), style: "text-decoration: none; padding: 5px 10px; border: 1px solid #ccc;" %>
  </div>

  <table border="1" style="border-collapse: collapse; width: 100%; table-layout: fixed;">
    <thead>
      <tr style="background: #f4f4f4;">
        <th style="width: 150px; padding: 10px;">ÁèæÂ†¥Âêç</th>
        <% @dates.each do |date| %>
          <th style="padding: 10px; <%= 'color: red;' if date.sunday? %>">
            <%= date.strftime("%m/%d") %><br>
            <small>(<%= %w(Êó• Êúà ÁÅ´ Ê∞¥ Êú® Èáë Âúü)[date.wday] %>)</small>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% if @sites.empty? %>
        <tr>
          <td colspan="8" style="padding: 20px; text-align: center;">
            ÁèæÂ†¥„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<%= link_to "ÁèæÂ†¥„ÇíÁôªÈå≤„Åô„Çã", sites_path %>
          </td>
        </tr>
      <% end %>

      <% @sites.each do |site| %>
        <tr>
          <%# Â∑¶Á´ØÔºöÁèæÂ†¥Âêç„ÇíË°®Á§∫„Åô„ÇãÂàó %>
          <td style="padding: 10px; background: #fafafa; border: 1px solid #eee;">
            <strong><%= site.name %></strong>
          </td>

          <% @dates.each do |date| %>
            <td style="vertical-align: top; min-height: 120px; padding: 5px; background: white; border: 1px solid #eee;">
              <%# „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„ÅÆÂèñÂæó %>
              <% schedule = @schedules.find { |s| s.date == date && s.site_id == site.id } %>

              <%# 1. „É°„É≥„Éê„ÉºË°®Á§∫„ÉªËøΩÂä†ÔºàÊúÄ‰∏äÊÆµÔºâ %>
              <div style="min-height: 50px; margin-bottom: 10px;">
                <% if schedule %>
                  <% schedule.placements.order(:position_order).each do |p| %>
                    <div style="background: #eef; margin-bottom: 2px; padding: 3px; font-size: 0.8em; border-radius: 3px; display: flex; justify-content: space-between; align-items: center;">
                      <span>üë§ <%= p.member.name %></span>
                      <div style="display: flex; gap: 2px;">
                        <%= button_to "‚Üë", move_up_placement_path(p), method: :patch, style: "font-size: 9px; padding: 0 2px;" %>
                        <%= button_to "‚Üì", move_down_placement_path(p), method: :patch, style: "font-size: 9px; padding: 0 2px;" %>
                        <%= link_to "√ó", placement_path(p), data: { turbo_method: :delete }, style: "color: red; text-decoration: none; font-weight: bold; padding-left: 3px;" %>
                      </div>
                    </div>
                  <% end %>
                <% end %>

                <%= form_with url: placements_path, method: :post, local: true do |f| %>
                  <%= f.hidden_field :date, value: date %>
                  <%= f.hidden_field :site_id, value: site.id %>
                  <div style="max-height: 60px; overflow-y: auto; background: #f0f4ff; border: 1px solid #d0d7ef; margin-top: 5px;">
                    <% @members.each do |member| %>
                      <label style="display: block; font-size: 0.7em; padding-left: 2px;">
                        <%= check_box_tag "member_ids[]", member.id %> <%= member.name %>
                      </label>
                    <% end %>
                  </div>
                  <%= f.submit "‰∫∫ËøΩÂä†", style: "width: 100%; font-size: 0.7em; background: #4a90e2; color: white; border: none; margin-top: 2px; cursor: pointer;" %>
                <% end %>
              </div>

              <%# 2. Ëªä‰∏°Ë°®Á§∫„ÉªËøΩÂä†Ôºà‰∏≠ÊÆµÔºâ %>
              <div style="margin-bottom: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                <div style="margin-bottom: 3px;">
                  <% if schedule && schedule.vehicles.any? %>
                    <% schedule.vehicles.each do |v| %>
                      <span style="background: #ffeeba; font-size: 0.7em; padding: 1px 3px; border-radius: 3px; display: inline-block; margin-bottom: 2px;">üöö <%= v.name %></span>
                    <% end %>
                  <% end %>
                </div>

                <%= form_with url: vehicle_assignments_path, method: :post, local: true do |f| %>
                  <%= f.hidden_field :date, value: date %>
                  <%= f.hidden_field :site_id, value: site.id %>
                  <div style="max-height: 50px; overflow-y: auto; background: #fffdf0; border: 1px solid #ffeeba;">
                    <% @vehicles.each do |v| %>
                      <label style="display: block; font-size: 0.65em; padding-left: 2px;">
                        <% is_checked = schedule&.vehicle_ids&.include?(v.id) %>
                        <%= check_box_tag "vehicle_ids[]", v.id, is_checked %> <%= v.name %>
                      </label>
                    <% end %>
                  </div>
                  <%= f.submit "ËªäÁ¢∫ÂÆö", style: "width: 100%; font-size: 0.7em; background: #f39c12; color: white; border: none; margin-top: 2px; cursor: pointer;" %>
                <% end %>
              </div>

              <%# 3. „É°„É¢Ë°®Á§∫„ÉªÂÖ•ÂäõÔºà‰∏ãÊÆµÔºâ %>
              <div style="border-top: 1px dashed #ccc; padding-top: 5px;">
                <%= form_with url: update_memo_schedules_path, method: :patch, local: true do |f| %>
                  <%= hidden_field_tag :date, date %>
                  <%= hidden_field_tag :site_id, site.id %>
                  <div style="font-size: 0.65em; color: #777;">üìù „É°„É¢</div>
                  <%= text_area_tag :memo, schedule&.memo,
                      placeholder: "ÂÇôËÄÉ...",
                      style: "width: 100%; font-size: 0.7em; height: 35px; border: 1px solid #ddd; box-sizing: border-box;" %>
                  <%= f.submit "‰øùÂ≠ò", style: "width: 100%; font-size: 0.7em; background: #95a5a6; color: white; border: none; margin-top: 2px; cursor: pointer;" %>
                <% end %>
              </div>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px;">
    <h3>Ë®≠ÂÆö„É°„Éã„É•„Éº</h3>
    <%= link_to "ÁèæÂ†¥ÁÆ°ÁêÜ", sites_path %> |
    <%= link_to "„É°„É≥„Éê„ÉºÁÆ°ÁêÜ", members_path %> |
    <%= link_to "Ëªä‰∏°ÁÆ°ÁêÜ", vehicles_path %>
  </div>
</div>
