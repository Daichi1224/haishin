<%# 画面上部：ナビゲーション（印刷時には非表示） %>
<div class="no-print" style="background: #1a202c; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <div style="color: white; font-weight: bold; font-size: 1.2em; letter-spacing: 0.1em;">配神</div>

  <%= link_to dashboard_path(date: @base_date),
      style: "background: #4a5568; color: white; text-decoration: none; padding: 8px 20px; border-radius: 6px; font-size: 0.9em; font-weight: bold; transition: background 0.2s;",
      onmouseover: "this.style.background='#2d3748'",
      onmouseout: "this.style.background='#4a5568'" do %>
    ← 配置編集に戻る
  <% end %>
</div>

<div style="padding: 0; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; color: #333; background: white; max-width: 900px; margin: auto;">

  <%# --- 1ページ目：表紙 & 注意書き --- %>
  <div class="first-page" style="border: 2px solid #000; padding: 60px 40px; box-sizing: border-box; background: #fff; margin: 10px; border-radius: 12px; min-height: 96vh; display: flex; flex-direction: column;">

    <div style="flex-grow: 1.2;"></div>

    <div style="text-align: center; border-bottom: 5px double #000; margin-bottom: 40px; padding-bottom: 20px;">
      <h1 style="margin: 0; font-size: 32px; letter-spacing: 0.2em;">週間配置予定表</h1>
      <p style="margin: 15px 0 0 0; font-size: 20px; font-weight: bold; color: #444;">
        <%= @dates.first.strftime("%Y/%m/%d") %> 〜 <%= @dates.last.strftime("%m/%d") %>
      </p>
    </div>

    <div style="padding: 30px; border: 1px solid #e0e0e0; border-radius: 15px; background-color: #fafafa; line-height: 1.8; color: #333;">
      <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 25px; color: #d97706;">
        <span style="font-size: 1.8em; margin-right: 12px;">⚠️</span>
        <strong style="font-size: 1.3em; border-bottom: 2px solid #d97706;">重要なお願い</strong>
      </div>

      <div style="font-size: 1.05em;">
        <p style="margin-bottom: 20px; text-align: center;">
          いつも業務に尽力いただきありがとうございます。<br>
          円滑な現場運営のため、本紙の内容を必ず各自でご確認ください。
        </p>

        <div style="background: white; padding: 20px; border-radius: 10px; border-left: 8px solid #0056b3; margin-bottom: 20px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #0056b3;">【連絡・確認の徹底】</p>
          <p style="margin: 0; font-size: 0.95em;">
            連絡漏れ等を未然に防ぐため、本予定表を配布しています。各自しっかり内容を確認し、<strong>資材・道具の持ち帰りや準備</strong>については十分にご留意ください。
          </p>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px; border-left: 8px solid #666; margin-bottom: 20px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #444;">【情報の取り扱い】</p>
          <p style="margin: 0; font-size: 0.95em;">
            本紙にはスタッフの皆様の個人名が含まれています。外部への情報流出を防ぐため、取り扱いには十分ご注意をお願いいたします。
          </p>
        </div>

        <div style="margin-top: 30px; padding: 15px; border-top: 1px dashed #ddd; text-align: center; color: #666;">
          <p style="margin: 0;">※ 内容に間違いや疑問点がある場合は<br>速やかにご連絡をお願いいたします。</p>
        </div>
      </div>
    </div>

    <div style="flex-grow: 1;"></div>

    <div style="text-align: right; padding-top: 20px; font-weight: bold; font-size: 1em; color: #bbb;">
      &copy; <%= Time.current.year %> 配神
    </div>
  </div>

  <%# --- 2ページ目以降：配置データ --- %>
  <% @dates.each do |date| %>
    <div class="card-container" style="padding-top: 30px;">
      <div class="print-card" style="border: 2px solid #444; border-radius: 8px; overflow: hidden; background: white;">
        <div style="background: #444; color: white; padding: 10px; font-size: 1.2em; font-weight: bold;">
          <%= date.strftime("%m月%d日") %> (<%= %w(日 月 火 水 木 金 土)[date.wday] %>)
        </div>

        <div style="padding: 15px;">
          <%# 修正点：ダッシュボードでの現場の並び順（position）でソートを追加 %>
          <% daily_schedules = @schedules.select { |s| s.date.to_s == date.to_s && (s.placements.any? || s.vehicle_assignments.any? || s.memo.present?) }.sort_by { |s| s.site&.position || 0 } %>
          <% if daily_schedules.any? %>
            <% daily_schedules.each do |schedule| %>
              <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <%# 1. 現場名：schedule.site が存在するか確認して表示 %>
                <h3 style="margin: 0 0 8px 0; color: #0056b3; border-left: 5px solid #0056b3; padding-left: 10px; font-size: 1.2em;">
                  <%= schedule.site&.name || "現場名なし" %>
                </h3>

                <div style="display: flex; flex-wrap: wrap; gap: 20px; padding-left: 15px;">
                  <%# 2. メンバー：placementsを経由してmemberの名前を取得 %>
                  <div style="min-width: 180px;">
                    <strong style="font-size: 0.85em; color: #777;">【メンバー】</strong><br>
                    <div style="font-size: 1.1em; margin-top: 3px; font-weight: bold;">
                      <% if schedule.placements.any? %>
                        <%= schedule.placements.map { |p| "👤#{p.member&.name}" }.join("　") %>
                      <% else %>
                        <span style="color: #ccc; font-weight: normal;">未設定</span>
                      <% end %>
                    </div>
                  </div>
                  <%# 3. 車両：vehicle_assignmentsを経由してvehicleの名前を取得 %>
                  <% if schedule.vehicle_assignments.any? %>
                    <div>
                      <strong style="font-size: 0.85em; color: #777;">【車両】</strong><br>
                      <div style="font-size: 1.1em; margin-top: 3px;">
                        <%= schedule.vehicle_assignments.map { |va| "🚚#{va.vehicle&.name}" }.join("　") %>
                      </div>
                    </div>
                  <% end %>
                </div>

                <%# 4. 備考 %>
                <% if schedule.memo.present? %>
                  <div style="margin-top: 8px; padding: 8px; background: #f9f9f9; border: 1px dashed #ccc; font-size: 1em;">
                    <strong>備考:</strong> <%= schedule.memo %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p style="color: #999; font-style: italic; padding: 10px;">予定なし</p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# 操作用フローティングボタン %>
  <div style="position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px;" class="no-print">
    <button onclick="window.print()" style="padding: 15px 30px; font-size: 1.1em; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
      📄 印刷・PDF保存
    </button>
  </div>
</div>

<style>
  @media print {
    .no-print { display: none !important; }

    @page {
      size: A4;
      margin: 15mm;
    }

    body { background: white; margin: 0; padding: 0; }

    .first-page {
      page-break-after: always;
      break-after: page;
      margin-bottom: 0 !important;
    }

    .card-container {
      display: block;
      break-inside: avoid;
      page-break-inside: avoid;
      padding-top: 40px !important;
    }
  }
</style>
